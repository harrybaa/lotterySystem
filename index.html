<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style/style.css">
    <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="js/lottery.js"></script>
    <script type="text/javascript" src="js/blink.js"></script>
    <script type="text/javascript" src="js/storageManip.js"></script>
    <title>Lottery System</title>

  </head>

  <body>

    <!-- TITLE-->
    <div class="title-wrap">
      <h1 class="title-txt">抽奖</h1>
    </div>

    <!-- PLATE -->
    <div class="plate-wrap">
      <div class="plate-box">
        <div class="led-line">
        </div>
        <div class="prize-wrap">
          <div class="prize-box" id="prize_box_1"></div>
          <div class="prize-box" id="prize_box_2"></div>
          <div class="prize-box" id="prize_box_3"></div>
          <div class="prize-box" id="prize_box_4"></div>
          <div class="prize-box" id="prize_box_5"></div>
          <div class="prize-box" id="prize_box_6"></div>
          <div class="prize-box" id="prize_box_7"></div>
          <div class="prize-box" id="prize_box_8"></div>
          <div class="prize-box" id="prize_box_9"></div>

          <div class="lot-botton" id="lot_btn"></div>

          <div class="clear-both"></div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      <div class="auth">
        <ul>
          <li>奖品以实物为准</li>
          <li>本活动最终解释权归沉静所有</li>
        </ul>
      </div>

    </div>

    <div class="foot-dec foot-dec-left">

    </div>

    <div class="foot-dec foot-dec-right">

    </div>

    <!-- RESULT WINDOW -->
    <div class="result-wrap hide">
      <div class="result-box">
        <div class="prize-rank" id="prize_rank_wrap">
          <p id="prize_rank">NULL</p>
        </div>
        <div class="img-wrap prize-pic-wrap">
          <div class="sticker">

          </div>
          <div class="sticker">

          </div>
          <p class="prize-name" id="prize_name">null</p>
        </div>
        <div class="prize-slogo">
          <p class="prize-tip">那時花開 幽藍歸來</p>
        </div>
        <div class="close-btn img-wrap" id="close_btn">
          X
        </div>
      </div>
    </div>

    <script>

      var LOTSYS = new Lottery();
      var BLKSYS = new Blink();
      var LSMSYS = new localStorageManip();
      var prizeQuantity;
      var prize;

      var showResult = function(prize) {
        console.log(prize);
        $(".result-wrap").removeClass("hide");
        $(".result-wrap #prize_rank").html(prize.rank);
        $(".result-wrap #prize_name").html(prize.name);
        clearState();
      }

      var clearState = function() {
        BLKSYS.clearBlink();
        $("#lot_btn").removeClass("hide");
        BLKSYS.startBlink();
      }

      var catchPrizeDetailData = function(urlPrefix) {
        var url = urlPrefix + "prizeDetails.json";

        $.ajax({
          url: url,
          dataType: 'json',
          success: function(res){
            console.log('Detail data loaded.');
            renderDetails(res);
          },
          error: function(){
            console.log('Faild to load detail data.');
            setFakePrizeDetails();
          }
        });
      };

      var catchPrizeQuantityData = function(urlPrefix) {
        var url = urlPrefix + "prizeQuantity.json";

        // already in local storage
        if(localStorage.getItem("prizeQuantity") != null)
          return;

        $.ajax({
          url: url,
          dataType: 'json',
          success: function(res){
            console.log('Quantity data loaded.');
            renderQuantity(res);
          },
          error: function(){
            console.log('Faild to load quantity data.');
            setFakePrizeQuantity();
          }
        });
      }

      var renderDetails = function(res) {
        LOTSYS.setPrizeDetails(res.prizeDetails);
      }

      var renderQuantity = function(res) {
        LOTSYS.setPrizeQuantity(res.prizeQuantity);
        LSMSYS.setLSQuantity(res.prizeQuantity);
      }

      var setFakePrizeDetails = function() {
        LOTSYS.setFakePrizeDetails();
      }

      var setFakePrizeQuantity = function() {
        LOTSYS.setFakePrizeQuantity();
      }

      var setNewPrizeQuantityData = function() {
        LSMSYS.setLSQuantity(LOTSYS.getPrizeQuantity());
      }

      <!-- MAIN ENTRY -->
      $(document).ready(function() {
        var urlPrefix;

        LOTSYS.init();
        BLKSYS.startBlink();

        // load data
        if(location.hostname == "localhost")
          urlPrefix = location.href + "data/";
        else
          urlPrefix = "http://www.harrybaa.com/lab/lotterySystem/data/";

        catchPrizeDetailData(urlPrefix);
        catchPrizeQuantityData(urlPrefix);

        // register actions
        $("#lot_btn").click(function() {
          BLKSYS.clearBlink();
          $("#lot_btn").addClass("hide");
          BLKSYS.fastBlink();
          // try to catch newest data
          LOTSYS.setPrizeQuantity(LSMSYS.getLSQuantity());
          prize = LOTSYS.lot();
          setNewPrizeQuantityData();

          window.setTimeout(function(){showResult(prize)}, 1800);
        });

        $("#close_btn").click(function() {
          $(".result-wrap").addClass("hide");
        })

      });
    </script>
  </body>
</html>
